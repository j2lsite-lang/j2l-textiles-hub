name: Deploy GitHub Pages (Vite)

on:
  push:
    branches: ["principal"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: GitHub Pages SPA fixes (404 + handler) + nojekyll + CNAME
        run: |
          # Required for GitHub Pages when using files/folders starting with _
          touch dist/.nojekyll

          # Custom domain
          echo "www.j2ltextiles.fr" > dist/CNAME

          # 1) Real SPA 404 that redirects to /?/<path> (returns 200)
          cat > dist/404.html <<'EOF'
          <!DOCTYPE html>
          <html lang="fr">
            <head>
              <meta charset="utf-8" />
              <meta name="robots" content="noindex" />
              <script type="text/javascript">
                // SPA redirect for GitHub Pages (rafgraph/spa-github-pages)
                (function(l) {
                  var path = l.pathname;
                  var search = l.search ? l.search.substring(1).replace(/&/g, '~and~') : '';
                  var newUrl = l.protocol + '//' + l.host + '/?/' + path.substring(1) +
                    (search ? '&' + search : '') + l.hash;
                  l.replace(newUrl);
                }(window.location));
              </script>
            </head>
            <body></body>
          </html>
          EOF

          # 2) Ensure index.html has the matching handler (only inject if missing)
          if ! grep -q "spa-github-pages" dist/index.html; then
            perl -0777 -i -pe 's#</head>#\n<!-- spa-github-pages handler -->\n<script type="text/javascript">\n// https://github.com/rafgraph/spa-github-pages\n(function(l) {\n  if (l.search[1] === \"/\") {\n    var decoded = l.search.slice(1).split(\"&\").map(function(s) {\n      return s.replace(/~and~/g, \"&\");\n    }).join(\"?\");\n    window.history.replaceState(null, null,\n      l.pathname.slice(0, -1) + decoded + l.hash\n    );\n  }\n}(window.location));\n</script>\n</head>#s' dist/index.html
          fi

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
