name: Sync TopTex Catalog

on:
  # D√©clenchement manuel
  workflow_dispatch:
  # Ou planifi√© (tous les jours √† 3h du matin)
  schedule:
    - cron: '0 3 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Trigger Catalog Sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          echo "üöÄ Triggering catalog sync..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"action":"start"}' \
            "${SUPABASE_URL}/functions/v1/catsync")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üìã Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Sync triggered successfully!"
            JOB_ID=$(echo "$BODY" | grep -o '"jobId":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$JOB_ID" ]; then
              echo "üìä Job ID: $JOB_ID"
              echo "üîó Monitor at: ${SUPABASE_URL}/functions/v1/catsync?action=status"
            fi
          else
            echo "‚ùå Failed to trigger sync (HTTP $HTTP_CODE)"
            exit 1
          fi
